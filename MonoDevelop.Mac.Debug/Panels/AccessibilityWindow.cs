// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Collections.Generic;
using System.Text;
using AppKit;
using CoreGraphics;
using MonoDevelop.Mac.Debug.Services;

namespace MonoDevelop.Mac.Debug
{
	class AccessibilityWindow : NSWindow
	{
		const int margin = 10;
		readonly NSStackView contentView;

		public event EventHandler<NSView> RaiseAccessibilityIssueSelected;
		public event EventHandler AuditRequested;
		public event EventHandler ShowErrorsRequested;

		public AccessibilityWindow (CGRect frame) : base(frame, NSWindowStyle.Titled | NSWindowStyle.Resizable, NSBackingStore.Buffered, false)
		{
			ShowsToolbarButton = false;
			MovableByWindowBackground = false;

			contentView = NativeViewHelper.CreateVerticalStackView(margin);
			ContentView = contentView;

			var buttonContainer = NativeViewHelper.CreateHorizontalStackView();
			buttonContainer.Distribution = NSStackViewDistribution.FillEqually;
			contentView.AddArrangedSubview(buttonContainer);
			buttonContainer.WidthAnchor.ConstraintEqualToConstant (370).Active = true;
			buttonContainer.HeightAnchor.ConstraintEqualToConstant(50).Active = true;
			buttonContainer.CenterXAnchor.ConstraintEqualToAnchor(contentView.CenterXAnchor, 20).Active = true;

			var runAuditButton = NativeViewHelper.CreateButton("Run Audit");
			buttonContainer.AddArrangedSubview(runAuditButton);
			runAuditButton.Activated += (sender, e) => AuditRequested?.Invoke (this, EventArgs.Empty);

			var showHideErrorsButton = NativeViewHelper.CreateButton("Show/Hide Errors");
			buttonContainer.AddArrangedSubview(showHideErrorsButton);
			contentView.AddArrangedSubview(new NSView() { TranslatesAutoresizingMaskIntoConstraints = false });
			showHideErrorsButton.Activated += (sender, e) => ShowErrorsRequested?.Invoke(this, EventArgs.Empty);

			errorLabel = NativeViewHelper.CreateLabel("");
			buttonContainer.AddArrangedSubview(errorLabel);

			var accessibilityService = AccessibilityService.Current;
			accessibilityService.ScanFinished += (s, e) =>
			{
				errorLabel.StringValue = string.Format("{0} errors found.", accessibilityService.IssuesFound);
			};

			outlineAccessibilityView = new OutlineView();
			outlineAccessibilityView.HeaderView = null;

			var outlineViewScrollView = new ScrollContainerView(outlineAccessibilityView);
			contentView.AddArrangedSubview(outlineViewScrollView);

			outlineAccessibilityView.SelectionNodeChanged += (s, e) => {
				if (outlineAccessibilityView.SelectedNode is NodeIssue nodeView)
				{
					RaiseAccessibilityIssueSelected?.Invoke(this, nodeView.DetectedError?.View);
				}
			};

			outlineAccessibilityView.DoubleClick += (s,e) => {
				outlineAccessibilityView.ExpandItem(outlineAccessibilityView.SelectedNode, true);
			};

			outlineAccessibilityView.OutlineTableColumn.Title = "Issues";

			var service = AccessibilityService.Current;
			service.ScanFinished += (s, window) =>
			{
				var nodeBase = new NodeIssue("Issues");
				foreach (var error in service.DetectedErrors)
				{
					nodeBase.AddChild(new NodeIssue(error));
				}
				outlineAccessibilityView.SetData(nodeBase);
			};

		}

		readonly OutlineView outlineAccessibilityView;

		public string IssuesLabel
		{
			get => errorLabel.StringValue;
			set => errorLabel.StringValue = value;
		}

		readonly NSTextField errorLabel;
	}

	class NodeIssue : Node
	{
		public DetectedError DetectedError { get; }

		static string GetName(DetectedError error)
		{
			var title = error.GetTitleMessage();
			var name = string.Format("{0} ({1}) : {2}", error.View.GetType(), error.View.Identifier ?? "N.I", title);
			return name;
		}

		public NodeIssue(DetectedError detectedError) : base(GetName (detectedError))
		{
			this.DetectedError = detectedError;

			List<string> children = new List<string>();
			var type = detectedError.View.GetType().ToString();
			if (detectedError.ErrorType.HasFlag(DetectedErrorType.AccessibilityHelp))
			{
				children.Add($"This {type} needs set the AccessibilityHelp field");
			}
			if (detectedError.ErrorType.HasFlag(DetectedErrorType.AccessibilityTitle))
			{
				children.Add($"This {type} needs set the AccessibilityTitle field");
			}
			if (detectedError.ErrorType.HasFlag(DetectedErrorType.AccessibilityParent))
			{
				children.Add($"This {type} needs set the AccessibilityParent field");
			}

			if (detectedError.ErrorType.HasFlag(DetectedErrorType.Contrast))
			{
				children.Add(string.Format("The text constrast ratio is {0}. This is based in color {1} compared with color {2}", detectedError.ContrastRatio, detectedError.Color1, detectedError.Color2));
			}

			foreach (var item in children)
			{
				AddChild(new NodeIssue(item));
			}
		}

		public NodeIssue(string view) : base(view)
		{
		}
	}
}
